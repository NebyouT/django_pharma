{% extends 'pharmacy/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                {% if show_only_low_stock %}
                    Low Stock Medicines
                {% elif show_only_expired %}
                    Expired Medicines
                {% else %}
                    Medicine List
                {% endif %}
            </h2>
            <div class="text-black">
                {% if show_only_low_stock %}
                    Total Low Stock Medicines: {{ total_medicines }}
                {% elif show_only_expired %}
                    Total Expired Medicines: {{ total_medicines }}
                {% else %}
                    Total Medicines: {{ total_medicines }} | 
                    {% if empty_descriptions > 0 %}
                        <span class="text-black">{{ empty_descriptions }} medicines without descriptions</span>
                        {% if perms.pharmacy.delete_medicine %}
                            <a href="{% url 'delete_empty_medicines' %}" class="btn btn-danger btn-sm ms-2" 
                               onclick="return confirm('Are you sure you want to delete all medicines without descriptions? This action cannot be undone.');">
                                <i class="fas fa-trash"></i> Delete Empty Medicines
                            </a>
                        {% endif %}
                    {% else %}
                        <span class="text-black">All medicines have descriptions</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div>
            {% if not show_only_low_stock and not show_only_expired %}
                <a href="{% url 'add_medicine' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Medicine
                </a>
            {% endif %}
        </div>
    </div>

    <div class="card">
        {% if not show_only_low_stock and not show_only_expired %}
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="complete-tab" data-bs-toggle="tab" href="#complete" role="tab">
                            Complete Medicines <span class="badge bg-success">{{ complete_medicines|length }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="incomplete-tab" data-bs-toggle="tab" href="#incomplete" role="tab">
                            Incomplete Medicines <span class="badge bg-warning">{{ incomplete_medicines|length }}</span>
                        </a>
                    </li>
                </ul>
            </div>
        {% endif %}
        <div class="card-body">
            <!-- Search Bar -->
            <div class="row mb-3">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" id="medicineSearch" class="form-control" placeholder="Search medicines...">
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content mt-3" id="medicinesTabContent">
                <!-- Complete Medicines Tab -->
                <div class="tab-pane fade show active" id="complete" role="tabpanel" aria-labelledby="complete-tab">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th color="black">Code</th>
                                    <th color="black">Description</th>
                                    <th color="black">Unit</th>
                                    <th color="black">Balance</th>
                                    <th color="black">Selling Price</th>
                                    <th color="black">Expiry Date</th>
                                    <th color="black">Status</th>
                                    <th color="black">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="completeMedicinesBody">
                                {% for medicine in complete_medicines %}
                                <tr>
                                    <td>{{ medicine.code }}</td>
                                    <td>{{ medicine.item_description }}</td>
                                    <td>{{ medicine.unit }}</td>
                                    <td>{{ medicine.balance }}</td>
                                    <td>{{ medicine.selling_price }}</td>
                                    <td>{{ medicine.expiry_date }}</td>
                                    <td>
                                        {% if medicine.is_low_stock %}
                                            <span class="badge bg-warning">Low Stock</span>
                                        {% else %}
                                            <span class="badge bg-success">In Stock</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'edit_medicine' medicine.id %}" class="btn btn-sm btn-primary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'delete_medicine' medicine.id %}" class="btn btn-sm btn-danger delete-medicine" title="Delete" onclick="return confirm('Are you sure you want to delete this medicine? This action cannot be undone.');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">No complete medicines found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Incomplete Medicines Tab -->
                <div class="tab-pane fade" id="incomplete" role="tabpanel" aria-labelledby="incomplete-tab">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th>Missing Information</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="incompleteMedicinesBody">
                                {% for medicine in incomplete_medicines %}
                                <tr>
                                    <td>{{ medicine.code|default:"Not set" }}</td>
                                    <td>{{ medicine.item_description|default:"Not set" }}</td>
                                    <td>{{ medicine.unit|default:"Not set" }}</td>
                                    <td>
                                        <ul class="list-unstyled mb-0 small">
                                            {% if not medicine.code %}<li><i class="fas fa-times text-danger"></i> Code</li>{% endif %}
                                            {% if not medicine.item_description %}<li><i class="fas fa-times text-danger"></i> Description</li>{% endif %}
                                            {% if not medicine.unit %}<li><i class="fas fa-times text-danger"></i> Unit</li>{% endif %}
                                            {% if not medicine.received_from %}<li><i class="fas fa-times text-danger"></i> Supplier</li>{% endif %}
                                            {% if not medicine.quantity %}<li><i class="fas fa-times text-danger"></i> Quantity</li>{% endif %}
                                            {% if not medicine.batch_number %}<li><i class="fas fa-times text-danger"></i> Batch Number</li>{% endif %}
                                            {% if not medicine.expiry_date %}<li><i class="fas fa-times text-danger"></i> Expiry Date</li>{% endif %}
                                            {% if not medicine.balance %}<li><i class="fas fa-times text-danger"></i> Balance</li>{% endif %}
                                            {% if not medicine.unit_price %}<li><i class="fas fa-times text-danger"></i> Unit Price</li>{% endif %}
                                            {% if not medicine.selling_price %}<li><i class="fas fa-times text-danger"></i> Selling Price</li>{% endif %}
                                        </ul>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'edit_medicine' medicine.id %}" class="btn btn-sm btn-warning" title="Complete Info">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'delete_medicine' medicine.id %}" class="btn btn-sm btn-danger delete-medicine" title="Delete" onclick="return confirm('Are you sure you want to delete this medicine? This action cannot be undone.');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No incomplete medicines found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('medicineSearch');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const value = this.value.toLowerCase();
            const rows = document.querySelectorAll('#completeMedicinesBody tr, #incompleteMedicinesBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(value) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
