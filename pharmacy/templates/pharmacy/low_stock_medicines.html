{% extends 'pharmacy/base.html' %}
{% load crispy_forms_tags %}

{% block extra_css %}
<style>
    .table-container {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 20px;
    }
    .table thead th {
        background-color: #f8f9fa;
    }
    .low-stock {
        color: #ffc107;
    }
    .medicine-search {
        border-radius: 20px;
        padding-left: 20px;
        margin-bottom: 20px;
    }
    .pagination {
        margin-top: 10px;
        margin-bottom: 0;
    }
    .page-info {
        margin-top: 10px;
        text-align: right;
        color: #6c757d;
    }
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-low {
        background-color: #ffc107;
    }
    .low-stock-row {
        background-color: #fff8e1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ title }}
                    </h3>
                    <span class="badge bg-light text-warning">Total: {{ medicines|length }}</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" id="medicineSearch" class="form-control medicine-search" placeholder="Search medicines by code or description...">
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-warning" onclick="printReport()">
                                    <i class="fas fa-print"></i> Print Report
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table table-hover" id="medicineTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Item Description</th>
                                    <th>Unit</th>
                                    <th>Category</th>
                                    <th>Batch Number</th>
                                    <th>Quantity</th>
                                    <th>Displayed Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Selling Price</th>
                                    <th>Expiry Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medicine in medicines %}
                                <tr class="low-stock-row">
                                    <td>{{ medicine.code }}</td>
                                    <td>{{ medicine.item_description }}</td>
                                    <td>{{ medicine.unit }}</td>
                                    <td>{{ medicine.category }}</td>
                                    <td>{{ medicine.batch_number }}</td>
                                    <td class="low-stock">
                                        {{ medicine.quantity }}
                                        <span class="badge bg-warning text-dark">Low Stock</span>
                                    </td>
                                    <td>{{ medicine.displayed_quantity }}</td>
                                    <td>{{ medicine.unit_price }} ETB</td>
                                    <td>{{ medicine.selling_price }} ETB</td>
                                    <td>{{ medicine.expiry_date }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="createPurchaseOrder('{{ medicine.id }}')">
                                            Create Purchase Order
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="11" class="text-center">No low stock medicines found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('medicineSearch');
    const table = document.getElementById('medicineTable');
    const rows = table.getElementsByTagName('tr');

    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        Array.from(rows).forEach((row, index) => {
            if (index === 0) return; // Skip header row
            
            const code = row.cells[0].textContent.toLowerCase();
            const description = row.cells[1].textContent.toLowerCase();
            const category = row.cells[3].textContent.toLowerCase();
            
            if (code.includes(searchTerm) || 
                description.includes(searchTerm) || 
                category.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

function createPurchaseOrder(medicineId) {
    // Add your purchase order creation logic here
    alert('Purchase order creation will be implemented soon.');
}

function printReport() {
    window.print();
}

function exportToExcel() {
    // Add Excel export logic here
    alert('Export to Excel feature will be implemented soon.');
}
</script>
{% endblock %}
